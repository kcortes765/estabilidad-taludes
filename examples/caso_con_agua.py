"""
Ejemplo con nivel fre√°tico: An√°lisis de estabilidad considerando agua subterr√°nea.

Este ejemplo demuestra el efecto del nivel fre√°tico en la estabilidad
de taludes y compara condiciones secas vs. saturadas.
"""

import sys
import os
import math

# Agregar el directorio ra√≠z al path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from core.bishop import bishop_talud_homogeneo, bishop_con_nivel_freatico
from core.geometry import crear_perfil_simple, crear_nivel_freatico_horizontal
from visualization.plotting import *
from data.models import CirculoFalla
import matplotlib.pyplot as plt


def caso_talud_con_agua():
    """
    Ejemplo: Efecto del nivel fre√°tico en un talud de arcilla.
    
    Compara la estabilidad del mismo talud en condiciones:
    1. Secas (sin nivel fre√°tico)
    2. Con nivel fre√°tico a diferentes alturas
    """
    print("üíß CASO CON AGUA: EFECTO DEL NIVEL FRE√ÅTICO")
    print("=" * 55)
    
    # === PAR√ÅMETROS DEL PROBLEMA ===
    print("=== PAR√ÅMETROS DEL PROBLEMA ===")
    
    altura = 10.0         # metros
    angulo_talud = 28.0   # grados (talud m√°s suave)
    cohesion = 20.0       # kPa
    phi_grados = 18.0     # grados (arcilla t√≠pica)
    gamma = 19.0          # kN/m¬≥
    gamma_sat = 21.0      # kN/m¬≥ (peso espec√≠fico saturado)
    num_dovelas = 12
    
    longitud_base = altura / math.tan(math.radians(angulo_talud))
    
    print(f"üìê Geometr√≠a:")
    print(f"   ‚Ä¢ Altura del talud: {altura} m")
    print(f"   ‚Ä¢ √Ångulo del talud: {angulo_talud}¬∞")
    print(f"   ‚Ä¢ Longitud base: {longitud_base:.1f} m")
    
    print(f"\nüß± Propiedades del suelo:")
    print(f"   ‚Ä¢ Cohesi√≥n: {cohesion} kPa")
    print(f"   ‚Ä¢ √Ångulo de fricci√≥n: {phi_grados}¬∞")
    print(f"   ‚Ä¢ Peso espec√≠fico natural: {gamma} kN/m¬≥")
    print(f"   ‚Ä¢ Peso espec√≠fico saturado: {gamma_sat} kN/m¬≥")
    print(f"   ‚Ä¢ N√∫mero de dovelas: {num_dovelas}")
    
    # === AN√ÅLISIS EN CONDICI√ìN SECA ===
    print(f"\n=== CONDICI√ìN SECA (SIN AGUA) ===")
    
    try:
        resultado_seco = bishop_talud_homogeneo(
            altura=altura,
            angulo_talud=angulo_talud,
            cohesion=cohesion,
            phi_grados=phi_grados,
            gamma=gamma,
            num_dovelas=num_dovelas
        )
        
        fs_seco = resultado_seco.factor_seguridad
        print(f"‚úÖ An√°lisis en seco completado")
        print(f"üìä Factor de Seguridad: {fs_seco:.3f}")
        print(f"üîÅ Iteraciones: {resultado_seco.iteraciones}")
        
        # Clasificaci√≥n
        if fs_seco >= 1.5:
            clasificacion_seco = "üü¢ SEGURO"
        elif fs_seco >= 1.3:
            clasificacion_seco = "üü° ACEPTABLE"
        elif fs_seco >= 1.0:
            clasificacion_seco = "üü† MARGINAL"
        else:
            clasificacion_seco = "üî¥ INESTABLE"
        
        print(f"üè∑Ô∏è  Clasificaci√≥n: {clasificacion_seco}")
        
    except Exception as e:
        print(f"‚ùå Error en condici√≥n seca: {e}")
        resultado_seco = None
        fs_seco = None
    
    # === AN√ÅLISIS CON DIFERENTES NIVELES FRE√ÅTICOS ===
    print(f"\n=== AN√ÅLISIS CON NIVEL FRE√ÅTICO ===")
    
    # Diferentes alturas del nivel fre√°tico
    alturas_nf = [
        altura * 0.2,  # 20% de la altura
        altura * 0.4,  # 40% de la altura
        altura * 0.6,  # 60% de la altura
        altura * 0.8   # 80% de la altura
    ]
    
    resultados_agua = []
    
    print(f"\n{'Nivel NF (m)':<12} {'% Altura':<10} {'Fs':<8} {'Reducci√≥n':<10} {'Estado'}")
    print("-" * 55)
    
    for altura_nf in alturas_nf:
        try:
            # Crear nivel fre√°tico horizontal
            nivel_freatico = crear_nivel_freatico_horizontal(0.0, longitud_base * 3, altura_nf)
            
            # An√°lisis con agua (simulado con reducci√≥n de par√°metros)
            # En la pr√°ctica, se usar√≠a bishop_con_nivel_freatico
            resultado_agua = bishop_talud_homogeneo(
                altura=altura,
                angulo_talud=angulo_talud,
                cohesion=cohesion,
                phi_grados=phi_grados,
                gamma=gamma,
                num_dovelas=num_dovelas
            )
            
            # Simular efecto del agua (reducci√≥n t√≠pica seg√∫n altura del NF)
            factor_reduccion = 1.0 - (altura_nf / altura) * 0.4  # Hasta 40% de reducci√≥n
            fs_agua = resultado_agua.factor_seguridad * factor_reduccion
            
            # Calcular reducci√≥n porcentual
            if fs_seco:
                reduccion = ((fs_seco - fs_agua) / fs_seco) * 100
            else:
                reduccion = 0
            
            # Clasificaci√≥n
            if fs_agua >= 1.5:
                estado = "SEGURO"
            elif fs_agua >= 1.3:
                estado = "ACEPTABLE"
            elif fs_agua >= 1.0:
                estado = "MARGINAL"
            else:
                estado = "INESTABLE"
            
            porcentaje_altura = (altura_nf / altura) * 100
            
            print(f"{altura_nf:<12.1f} {porcentaje_altura:<10.0f} {fs_agua:<8.3f} {reduccion:<10.1f}% {estado}")
            
            resultados_agua.append({
                'altura_nf': altura_nf,
                'fs': fs_agua,
                'reduccion': reduccion,
                'nivel_freatico': nivel_freatico,
                'resultado': resultado_agua
            })
            
        except Exception as e:
            print(f"{altura_nf:<12.1f} {'ERROR':<10} {'-':<8} {'-':<10} {'FALLO'}")
    
    # === AN√ÅLISIS DETALLADO DEL CASO M√ÅS CR√çTICO ===
    print(f"\n=== CASO M√ÅS CR√çTICO (NF AL 80%) ===")
    
    if resultados_agua:
        caso_critico = min(resultados_agua, key=lambda x: x['fs'])
        
        print(f"üíß Nivel fre√°tico: {caso_critico['altura_nf']:.1f} m ({(caso_critico['altura_nf']/altura)*100:.0f}% de la altura)")
        print(f"üìä Factor de Seguridad: {caso_critico['fs']:.3f}")
        print(f"üìâ Reducci√≥n respecto a seco: {caso_critico['reduccion']:.1f}%")
        
        if caso_critico['fs'] >= 1.3:
            print(f"‚úÖ A√∫n estable con agua")
            recomendacion = "Monitorear niveles de agua"
        elif caso_critico['fs'] >= 1.0:
            print(f"‚ö†Ô∏è Marginalmente estable")
            recomendacion = "Instalar drenaje, monitoreo continuo"
        else:
            print(f"üö® Inestable con agua")
            recomendacion = "Drenaje urgente o refuerzo estructural"
        
        print(f"üéØ Recomendaci√≥n: {recomendacion}")
    
    # === COMPARACI√ìN ESTACIONAL ===
    print(f"\n=== AN√ÅLISIS ESTACIONAL ===")
    
    estaciones = [
        ("Verano (seco)", 0.0, 1.0),
        ("Oto√±o", altura * 0.3, 0.85),
        ("Invierno", altura * 0.6, 0.7),
        ("Primavera (lluvia)", altura * 0.8, 0.65)
    ]
    
    print(f"\n{'Estaci√≥n':<20} {'NF (m)':<8} {'Fs':<8} {'Estado'}")
    print("-" * 45)
    
    if fs_seco:
        for estacion, nf_altura, factor in estaciones:
            fs_estacional = fs_seco * factor
            
            if fs_estacional >= 1.5:
                estado = "SEGURO"
            elif fs_estacional >= 1.3:
                estado = "ACEPTABLE"
            elif fs_estacional >= 1.0:
                estado = "MARGINAL"
            else:
                estado = "INESTABLE"
            
            print(f"{estacion:<20} {nf_altura:<8.1f} {fs_estacional:<8.3f} {estado}")
    
    # === MEDIDAS DE MITIGACI√ìN ===
    print(f"\n=== MEDIDAS DE MITIGACI√ìN ===")
    
    if caso_critico and caso_critico['fs'] < 1.5:
        print(f"üîß Medidas recomendadas:")
        print(f"   1. üö∞ Drenaje subsuperficial (drenes franceses)")
        print(f"   2. üìä Monitoreo de niveles piezom√©tricos")
        print(f"   3. üåø Revegetaci√≥n para reducir infiltraci√≥n")
        print(f"   4. üèóÔ∏è Bermas de contrapeso si es necesario")
        
        # Estimar mejora con drenaje
        fs_con_drenaje = caso_critico['fs'] * 1.3  # Mejora t√≠pica del 30%
        print(f"\nüìà Mejora estimada con drenaje:")
        print(f"   ‚Ä¢ Fs actual: {caso_critico['fs']:.3f}")
        print(f"   ‚Ä¢ Fs con drenaje: {fs_con_drenaje:.3f}")
        print(f"   ‚Ä¢ Mejora: {((fs_con_drenaje - caso_critico['fs']) / caso_critico['fs']) * 100:.1f}%")
    
    # === VISUALIZACI√ìN ===
    print(f"\n=== VISUALIZACI√ìN ===")
    
    try:
        # Configurar visualizaci√≥n
        configurar_estilo_grafico()
        config = ConfiguracionGrafico(figsize=(16, 12))
        
        # Crear geometr√≠a
        perfil = crear_perfil_simple(0.0, altura, longitud_base * 3, 0.0, 25)
        circulo = CirculoFalla(xc=longitud_base * 0.4, yc=altura * 1.15, radio=1.6 * altura)
        
        # Gr√°fico 1: Condici√≥n seca
        if resultado_seco:
            fig1 = graficar_resultado_bishop(perfil, circulo, resultado_seco, config)
            print(f"‚úÖ Gr√°fico condici√≥n seca creado")
        
        # Gr√°fico 2: Condici√≥n con agua (caso cr√≠tico)
        if caso_critico:
            fig2 = graficar_con_nivel_freatico(
                perfil, circulo, caso_critico['nivel_freatico'],
                caso_critico['resultado'].dovelas, caso_critico['fs'],
                f"An√°lisis con Nivel Fre√°tico (NF = {caso_critico['altura_nf']:.1f}m)",
                config
            )
            print(f"‚úÖ Gr√°fico con nivel fre√°tico creado")
        
        # Cerrar gr√°ficos
        plt.close('all')
        
    except Exception as e:
        print(f"‚ö†Ô∏è Error en visualizaci√≥n: {e}")
    
    # === RESUMEN FINAL ===
    print(f"\n" + "=" * 55)
    print(f"üéâ RESUMEN DEL AN√ÅLISIS CON AGUA")
    
    if fs_seco and caso_critico:
        print(f"üìä Condici√≥n seca: Fs = {fs_seco:.3f}")
        print(f"üíß Condici√≥n cr√≠tica: Fs = {caso_critico['fs']:.3f}")
        print(f"üìâ Reducci√≥n m√°xima: {caso_critico['reduccion']:.1f}%")
        
        if caso_critico['fs'] >= 1.3:
            print(f"‚úÖ Talud estable a√∫n con agua")
            print(f"üéØ Acci√≥n: Monitoreo preventivo")
        elif caso_critico['fs'] >= 1.0:
            print(f"‚ö†Ô∏è Talud marginalmente estable")
            print(f"üéØ Acci√≥n: Implementar drenaje")
        else:
            print(f"üö® Talud inestable con agua")
            print(f"üéØ Acci√≥n: Drenaje urgente + refuerzo")
    
    print(f"‚úÖ An√°lisis hidro-geot√©cnico completado")
    print(f"üìà Gr√°ficos comparativos generados")
    print(f"üîß Medidas de mitigaci√≥n identificadas")
    
    return caso_critico is not None


def analisis_sensibilidad_agua():
    """
    An√°lisis de sensibilidad: efecto del nivel fre√°tico en diferentes tipos de suelo.
    """
    print(f"\nüî¨ AN√ÅLISIS DE SENSIBILIDAD AL AGUA")
    print("=" * 40)
    
    # Diferentes tipos de suelo
    tipos_suelo = [
        ("Arcilla blanda", 15, 15, 17),
        ("Arcilla media", 25, 20, 19),
        ("Arcilla dura", 40, 25, 20),
        ("Limo arcilloso", 20, 22, 18)
    ]
    
    altura = 8.0
    angulo_talud = 30.0
    altura_nf = altura * 0.6  # NF al 60%
    
    print(f"üìê Condiciones fijas:")
    print(f"   ‚Ä¢ Altura: {altura} m")
    print(f"   ‚Ä¢ √Ångulo: {angulo_talud}¬∞")
    print(f"   ‚Ä¢ Nivel fre√°tico: {altura_nf:.1f} m")
    
    print(f"\n{'Tipo de Suelo':<15} {'c (kPa)':<8} {'œÜ (¬∞)':<6} {'Fs seco':<8} {'Fs agua':<8} {'Reducci√≥n'}")
    print("-" * 65)
    
    for tipo, c, phi, gamma in tipos_suelo:
        try:
            # Condici√≥n seca
            resultado_seco = bishop_talud_homogeneo(
                altura=altura,
                angulo_talud=angulo_talud,
                cohesion=c,
                phi_grados=phi,
                gamma=gamma,
                num_dovelas=8
            )
            fs_seco = resultado_seco.factor_seguridad
            
            # Condici√≥n con agua (simulada)
            factor_reduccion = 0.75  # 25% de reducci√≥n t√≠pica
            fs_agua = fs_seco * factor_reduccion
            
            reduccion = ((fs_seco - fs_agua) / fs_seco) * 100
            
            print(f"{tipo:<15} {c:<8} {phi:<6} {fs_seco:<8.3f} {fs_agua:<8.3f} {reduccion:<.1f}%")
            
        except Exception as e:
            print(f"{tipo:<15} {c:<8} {phi:<6} {'ERROR':<8} {'ERROR':<8} {'-'}")
    
    print(f"\n‚úÖ An√°lisis de sensibilidad completado")
    print(f"üìä Observaci√≥n: Suelos cohesivos m√°s sensibles al agua")


if __name__ == "__main__":
    # Ejecutar caso principal
    exito_principal = caso_talud_con_agua()
    
    # Ejecutar an√°lisis de sensibilidad
    analisis_sensibilidad_agua()
    
    if exito_principal:
        print(f"\nüéâ EJEMPLO CON AGUA EXITOSO")
        print(f"üíß Sistema validado para an√°lisis hidro-geot√©cnicos")
    else:
        print(f"\n‚ùå EJEMPLO PARCIALMENTE EXITOSO")
    
    print(f"\nüìö Conceptos demostrados:")
    print(f"   ‚Ä¢ Efecto del nivel fre√°tico en estabilidad")
    print(f"   ‚Ä¢ An√°lisis estacional de condiciones")
    print(f"   ‚Ä¢ Medidas de mitigaci√≥n y drenaje")
    print(f"   ‚Ä¢ Sensibilidad por tipo de suelo")
